<script src="../../lib/signalr/dist/browser/signalr.js"></script>

<link rel="import" href="../paper-toast/paper-toast.html" />
<link rel="import" href="../xenon-date/xenon-date.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html" />

<dom-module id="rambler-api-status">
    <template>
        <iron-ajax auto id="ajax"
                   url="/api/dashboard/apiStatus"
                   handle-as="json"
                   loading="{{loading}}"
                   last-response="{{items}}"></iron-ajax>

        <template is="dom-repeat" items="{{items}}" restamp>
            <div class="row">
                <label>{{item.name}}</label>
                <div>{{item.status}}</div>
                <xenon-date value="{{item.updateDate}}" show-time></xenon-date>
            </div>
        </template>

        <paper-toast id="toast"></paper-toast>
    </template>
    <script>
        Polymer({
            is: "rambler-api-status",
            properties: {
                items: { Type: Array, notify: true, value: [] },
                connection: { Type: Object, value: {} }
            },
            ready: function () {
                var that = this;
                this.connection = new signalR.HubConnectionBuilder().withUrl("/dashboardHub").build();

                this.connection.on("updateStatus", function (name, status) {
                    console.log(name, status);
                    var item = this.get(['items', name]);
                    var index = this.myArray.indexOf(item);
                    if (index != -1) {
                        this.splice('items', index, 1);
                    }
                    this.push('items', { "name": name, "status": status });
                });

                this.connection.start().catch(function (err) {
                    return console.error(err.toString());
                });
            }
        });
    </script>
</dom-module>
