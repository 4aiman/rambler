<script src="../../lib/signalr/dist/browser/signalr.js"></script>

<link rel="import" href="../paper-toast/paper-toast.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html" />
<link rel="import" href="chat-message.html" />

<dom-module id="rambler-chat">
    <template>
        <iron-ajax auto id="ajax"
                   url="/api/chat"
                   handle-as="json"
                   loading="{{loading}}"
                   last-response="{{messages}}"></iron-ajax>

        <div class="chat">
            <template is="dom-repeat" items="{{messages}}" restamp>
                <template is="dom-if" if="[[showDate]]">
                    <chat-message item="{{item}}" show-date timeout="[[timeout]]"></chat-message>
                </template>
                <template is="dom-if" if="[[!showDate]]">
                    <chat-message item="{{item}}" timeout="[[timeout]]"></chat-message>
                </template>
            </template>
        </div>
        <paper-toast id="toast"></paper-toast>
    </template>
    <script>
        HTMLImports.whenReady(function () {
            Polymer({
                is: "rambler-chat",
                properties: {
                    messages: { type: Array, notify: true, value: [] },
                    connection: { type: Object, value: {} },
                    channel: { type: String, value: "All" },
                    showDate: { type: Boolean, value: false }
                },
                _onMessageReceived: function (message) {
                    if (!message) return;
                    //console.log(message);
                    this.push("messages", message);
                    if (this.messages.length > 10) {
                        this.shift("messages");
                    }
                },
                ready: function () {
                    var that = this;
                    this.connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

                    this.connection.on("ReceiveChannelMessage", function (message) {
                        if (message.channel == that.channel) {
                            that._onMessageReceived(message.chatMessage);
                        }
                    });

                    this.connection.start().catch(function (err) {
                        return console.error(err.toString());
                    });
                }
            });
        });
    </script>
</dom-module>
